name: DataDevOps Pipeline CI/CD

on:
  push:
    branches: [ main, dev, int, 'copilot/**' ]
  pull_request:
    branches: [ main, dev, int ]
  workflow_dispatch:
    inputs:
      terraform_module:
        description: 'Terraform module to deploy'
        required: true
        type: choice
        options:
          - glue
        default: 'glue'
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - dev
          - prod
        default: 'dev'

env:
  DOCKER_IMAGE: gluepipeline-cli
  DOCKER_TAG: ${{ github.sha }}

jobs:
  build:
    name: Build and Test CLI
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Lint Python code
      run: |
        pip install flake8
        flake8 cli.py --max-line-length=120 --ignore=E501 || true
    
    - name: Test CLI commands
      run: |
        chmod +x cli.py
        python cli.py --help
        python cli.py init --name test-pipeline --environment dev
        python cli.py add-job --job-name test-job --script s3://bucket/test.py
        python cli.py list
        python cli.py validate
        python cli.py status
    
    - name: Upload configuration artifact
      uses: actions/upload-artifact@v4
      with:
        name: pipeline-config
        path: config.json
        retention-days: 7

  docker-build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: Build Docker image
      run: |
        docker build -t ${{ env.DOCKER_IMAGE }}:${{ env.DOCKER_TAG }} .
        docker tag ${{ env.DOCKER_IMAGE }}:${{ env.DOCKER_TAG }} ${{ env.DOCKER_IMAGE }}:latest
    
    - name: Test Docker image
      run: |
        mkdir -p workspace
        docker run --rm -v $(pwd)/workspace:/workspace ${{ env.DOCKER_IMAGE }}:latest --help
        docker run --rm -v $(pwd)/workspace:/workspace ${{ env.DOCKER_IMAGE }}:latest init --name docker-test --environment dev
    
    - name: Save Docker image
      run: |
        docker save ${{ env.DOCKER_IMAGE }}:latest | gzip > gluepipeline-cli.tar.gz
    
    - name: Upload Docker image artifact
      uses: actions/upload-artifact@v4
      with:
        name: docker-image
        path: gluepipeline-cli.tar.gz
        retention-days: 7

  docker-compose-test:
    name: Test Docker Compose
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Create workspace directory
      run: mkdir -p workspace
    
    - name: Test with Docker Compose
      run: |
        docker compose build
        docker compose run --rm gluepipeline-cli --help
        docker compose run --rm gluepipeline-cli init --name compose-test --environment dev
        docker compose run --rm gluepipeline-cli status

  validate:
    name: Validate Configuration
    runs-on: ubuntu-latest
    needs: [build, docker-build]
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Download pipeline config
      uses: actions/download-artifact@v4
      with:
        name: pipeline-config
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Validate configuration
      run: |
        python cli.py validate || true
        python cli.py status

  # Optional: Deploy stage for production
  deploy:
    name: Deploy Pipeline
    runs-on: ubuntu-latest
    needs: [build, docker-build, docker-compose-test, validate]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev'
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Download Docker image
      uses: actions/download-artifact@v4
      with:
        name: docker-image
    
    - name: Deploy notification
      run: |
        echo "Deploying GluePipeline CLI"
        echo "Branch: ${{ github.ref_name }}"
        echo "Commit: ${{ github.sha }}"
        echo "Deployment ready"

  # Terraform deployment job (manual trigger only)
  terraform-deploy:
    name: Deploy Terraform Infrastructure
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: 1.5.0
    
    - name: Display deployment configuration
      run: |
        echo "Terraform Module: ${{ github.event.inputs.terraform_module }}"
        echo "Environment: ${{ github.event.inputs.environment }}"
        echo "Working Directory: terraform/aws/${{ github.event.inputs.terraform_module }}"
    
    - name: Terraform Init
      working-directory: terraform/aws/${{ github.event.inputs.terraform_module }}
      run: terraform init
    
    - name: Terraform Validate
      working-directory: terraform/aws/${{ github.event.inputs.terraform_module }}
      run: terraform validate
    
    - name: Terraform Plan
      working-directory: terraform/aws/${{ github.event.inputs.terraform_module }}
      run: |
        terraform plan -var-file="../../../envconfig/aws/${{ github.event.inputs.environment }}.tfvars" -out=tfplan
    
    - name: Terraform Plan Summary
      working-directory: terraform/aws/${{ github.event.inputs.terraform_module }}
      run: |
        echo "Terraform plan completed successfully"
        echo "Review the plan above before applying"
        echo "Note: Actual terraform apply requires AWS credentials and approval"
